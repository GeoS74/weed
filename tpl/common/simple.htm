<!DOCTYPE HTML><html lang="ru"><head><title><?=PAGE_TITLE?></title>
<?include_once ROOT_PATH.'/tpl/common/header.htm';?>
<style>form{margin:20px}#content{margin:20px}#content li{margin:10px}input[type=text],select{margin-right:8px}input[name=title]{width:250px}input[name=pos]{width:50px}</style>
<script type="text/javascript" src="<?=BASE?>/lib/dev/Elementary.js"></script><script type="text/javascript" src="<?=BASE?>/js/class/Graf.js"></script></head><body><?include_once ROOT_PATH.'/tpl/common/hellouser.htm';
include_once ROOT_PATH.'/tpl/common/menu.htm';
?><h1><?=PAGE_TITLE?></h1><form method="post" id="add_form"><input type="text" name="title" placeholder="Новая запись..." autofocus/><select name="parent_id"></select><input type="text" name="pos" placeholder="Поз."/><input type="submit" value="Сохранить" class="submit_ok"/></form><script>add_form.addEventListener('submit',function(){event.preventDefault();frontend_data.tmpl_data.event='add';frontend_data.form_data=new FormData(this);backend.query();this.reset()});let frontend_data={tmpl_data:{module:'<?=MODULE?>',template:'<?=TMPL_NAME?>',event:'',},form_data:{},};let backend=new El().setPath('<?=BACKEND_CONTROLLER?>').setData(frontend_data).query();new El(null,backend).setHandler(function(){let option=optionHtml({id:0,title:'Выбрать группу',level:1});new Graf(this.model.getVal()).sortBy('pos').each(function(){option+=optionHtml(this)});add_form.querySelector('select[name="parent_id"]').innerHTML=option;edit_form.elem.querySelector('select[name="parent_id"]').innerHTML=option});function optionHtml(data){return'<option value="'+data.id+'" data-level="'+data.level+'">'+prefix(data.level)+data.title+'</option>'}
function prefix(freq){for(var i=0,prefix='|-';i<freq;i++)prefix+='---';return prefix}
let content=new El('<ul id="content">',backend).render().setHandler(function(){this.elem.innerHTML='';this.observers=[];let self=this;new Graf(this.model.getVal()).sortBy('pos').each(function(){new El('<li id="'+self.observers.length+'">'+prefix(this.level)+this.title+'</li>',self).setParentNode(self.elem).setVal(this).render()})}).on('dblclick',function(){let li=event.target.closest('li');if(!li)return;li.hidden=!0;edit_form.setVal({'event':'reset'}).setVal({'event':'fill','value':content.observers[li.getAttribute('id')].getVal()}).setParentNode(li).render('afterend')});let edit_form=new El('<form id="edit_form">').on('submit',function(){event.preventDefault()}).setHandler(function(){if(this.getVal().event=='reset'){if(this.elem.previousElementSibling)this.elem.previousElementSibling.hidden=!1;this.elem.reset();this.elem.remove()}});new El('<input type=text name="title" placeholder="Изменить запись..."/>',edit_form).setParentNode(edit_form.elem).render().setHandler(function(){if(this.model.getVal().event=='fill')
if(this.model.getVal().value.title)this.elem.value=this.model.getVal().value.title});new El('<select name="parent_id">',edit_form).setParentNode(edit_form.elem).render().setHandler(function(){if(this.model.getVal().event=='fill'){if(this.model.getVal().value.parent_id){this.elem.querySelector('option[value="'+this.model.getVal().value.parent_id+'"]').selected=!0;for(let i=0,nodes=this.elem.childNodes;i<nodes.length;i++)nodes[i].disabled=!1;let option=this.elem.querySelector('option[value="'+this.model.getVal().value.id+'"]');option.disabled=!0;var level=option.dataset.level;while(option=option.nextElementSibling){if(option.dataset.level<=level)break;option.disabled=!0}}}});new El('<input type=text name="pos" placeholder="Поз."/>',edit_form).setParentNode(edit_form.elem).render().setHandler(function(){if(this.model.getVal().event=='fill')
if(this.model.getVal().value.pos)this.elem.value=this.model.getVal().value.pos});new El('<input type="submit" value="Сохранить" class="submit_ok"/>').setParentNode(edit_form.elem).render().on('click',function(){frontend_data.tmpl_data.event='upd';let fd=new FormData(edit_form.elem);fd.append('id',edit_form.getVal().value.id);frontend_data.form_data=fd;backend.query();edit_form.setVal({'event':'reset'})});new El('<span class="submit_cancel">Отмена<span/>').setParentNode(edit_form.elem).render().on('click',function(){edit_form.setVal({'event':'reset'})});new El('<span class="submit_delete">Удалить<span/>').setParentNode(edit_form.elem).render().on('click',function(){if(!confirm('Вы действительно хотите удалить запись?'))return;frontend_data.tmpl_data.event='del';frontend_data.form_data={id:edit_form.getVal().value.id};backend.query();edit_form.setVal({'event':'reset'})})</script></body></html>